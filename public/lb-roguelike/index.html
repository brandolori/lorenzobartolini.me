<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lb-roguelike</title>
  <script type="module" crossorigin>(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const c of l)if(c.type==="childList")for(const p of c.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&i(p)}).observe(document,{childList:!0,subtree:!0});function s(l){const c={};return l.integrity&&(c.integrity=l.integrity),l.referrerPolicy&&(c.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?c.credentials="include":l.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(l){if(l.ep)return;l.ep=!0;const c=s(l);fetch(l.href,c)}})();const G=e=>{const o=Math.floor(Math.random()*e.length);return e[o]},ve=(e,o,s,i,l)=>{document.addEventListener("keydown",n,!1),document.addEventListener("keyup",h,!1);const c=new Set,p=new Set,g={w:"move-up",W:"move-up",a:"move-left",A:"move-left",s:"move-down",S:"move-down",d:"move-right",D:"move-right",ArrowLeft:"shoot-left",ArrowUp:"shoot-up",ArrowDown:"shoot-down",ArrowRight:"shoot-right"};function n(y){y.key in g&&p.add(g[y.key])}function h(y){y.key in g&&p.delete(g[y.key])}let u=o,f;const x=(y,v)=>{setTimeout(()=>{c.add(y)},v*1e3)};l.forEach(y=>x(y.id,y.time));const k=y=>{f===void 0&&(f=y);const v=(y-f)/1e3;f=y,p.forEach(m=>c.add(m));const{timers:w,state:H}=s(u,c,v);c.clear(),u=H,w.forEach(m=>x(m.id,m.time));const I=i(u);Pe(e,I),requestAnimationFrame(k)};requestAnimationFrame(k)},Pe=(e,o)=>{const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height),o.forEach(i=>{const{x:l,y:c,char:p,size:g,color:n}=i;s.fillStyle=n,s.font=`bold ${g}px courier new`;const u=s.measureText(p).width,f=g,x=l-u/2,k=c+f/2;s.fillText(p,x,k)})},r={sum:(e,o)=>({x:e.x+o.x,y:e.y+o.y}),mult:(e,o)=>({x:e.x*o,y:e.y*o}),sub:(e,o)=>({x:e.x-o.x,y:e.y-o.y}),normalize:e=>{const o=Math.sqrt(e.x*e.x+e.y*e.y);return o===0?{x:0,y:0}:{x:e.x/o,y:e.y/o}},distance:(e,o)=>{const s=o.x-e.x,i=o.y-e.y;return Math.sqrt(s*s+i*i)},squareCollision:(e,o,s)=>Math.abs(e.x-o.x)<=s/2&&Math.abs(e.y-o.y)<=s/2,right:{x:1,y:0},left:{x:-1,y:0},up:{x:0,y:-1},down:{x:0,y:1},zero:{x:0,y:0},fromAngle:e=>({x:Math.cos(e),y:Math.sin(e)}),toAngle:e=>Math.atan2(e.y,e.x),random:e=>r.mult(r.fromAngle(Math.random()*Math.PI*2),e)},W="#000000",Ae="#00000080",ne="red",ae="pink",Re="green",q=80,Le=.25,U={x:324,y:36},He=10,D=120,a=24,S=648,M=360,le=5,Ie=20,Ee=2,X=a*2.5,Be=2,Oe=5,ie=1,Fe=5,z=(e,o,s,i,l,c)=>({pos:r.sum(e,r.mult(s,a/4)),speed:r.sum(r.mult(s,i),o),type:l,enemy:c,lifetime:0}),F=(e,o)=>{const s=r.toAngle(e);return r.fromAngle(s+Math.random()*o-o/2)},O=(e,o,s)=>z(r.sum(e,r.mult(r.fromAngle(Math.random()*Math.PI*2),a/4)),o,F(s,.2),D*(Math.random()*.25+3),"shotgun",!1),ce=e=>{switch(e){case"normal":return 1;case"small":return .5;case"big":return 2;case"shotgun":return .75;case"rocket":return 1}},me=(e,o)=>({x:e.x+Math.cos(o)*X,y:e.y+Math.sin(o)*X}),he=(e,o)=>({x:e.x+Math.cos(o+Math.PI)*X,y:e.y+Math.sin(o+Math.PI)*X}),Te=e=>{switch(e){case"none":return .3;case"big-gun":return .2;case"shotgun":return .75;case"uzi":return .1;case"glock":return .3}},ye=e=>({x:S-e.x,y:M-e.y}),de=e=>{const o=["bible","bible2","ghost","twins","passthrough","rubber","swamp","rocket","tombstone"];return{pos:e,type:G(["big-gun","shotgun","uzi","glock"]),trinket:G(o)}},Ve=e=>{switch(e){case"wall1":return"â–§";case"wall2":return"â—©";case"wall3":return"â–©";case"block":return"â–¥";case"door":return"â–£"}},K=e=>{switch(e){case"none":return"@";case"big-gun":return"Â£";case"shotgun":return"$";case"uzi":return"â‚¬";case"glock":return"Â¥"}},We=e=>{switch(e){case"big":return 1.5;case"normal":return 1;case"small":return .75;case"shotgun":return .75;case"rocket":return .5;default:return 1}},Ye=e=>{switch(e){case"slime":return"Ã§";case"fast-slime":return"Ã‡";case"turret":return"Â¡";case"imp":return"#";case"rhino":return"Â§";default:return"?"}},R=e=>{switch(e){case"twins":return"ðŸ‘¬";case"rubber":return"ðŸŽˆ";case"bible":return"ðŸ“•";case"bible2":return"ðŸ“˜";case"passthrough":return"ðŸªŸ";case"ghost":return"ðŸ‘»";case"swamp":return"ðŸ¸";case"bus":return"ðŸšŒ";case"rocket":return"ðŸš€";case"tombstone":return"ðŸª¦"}},Ne=e=>{if(e.playerState.health==0)return[{char:"You are dead.",color:"black",size:a*2,x:S/2,y:M/2}];if(e.won)return[{char:"You won!",color:"black",size:a*2,x:S/2,y:M/2}];const o={...e.playerState.pos,char:K(e.playerState.weapon),size:a,color:e.playerState.hurt?ae:W},s=e.bullets.map(m=>({char:m.type=="rocket"?"ðŸš€":m.enemy?"âœ¦":"â€¢",color:m.enemy?ne:W,size:a*We(m.type)*(m.enemy?.5:1),x:m.pos.x,y:m.enemy?m.pos.y+a*.25:m.pos.y})),i=e.enemies.map(m=>({char:Ye(m.type),color:m.hurt?ae:ne,size:a,...m.pos})),l=e.obstacles.map(m=>({char:Ve(m.type),color:W,size:a,...m.pos})),c=e.drops.flatMap(m=>({char:K(m.type)+R(m.trinket),color:Re,size:a/2,...m.pos})),p=Math.round(Math.max(e.playerState.health,0)/100*8),n={char:"["+"â– ".repeat(p)+" ".repeat(8-p)+"]",color:"#00000080",size:a/5,x:e.playerState.pos.x,y:e.playerState.pos.y+a*.75},h=Math.round(Math.max(e.playerState.weaponHealth,0)/100*8),f={char:"["+"â– ".repeat(h)+" ".repeat(8-h)+"]",color:e.playerState.weapon!="none"?"#30300080":"transparent",size:a/5,x:e.playerState.pos.x,y:e.playerState.pos.y+a},x=e.playerState.trinkets.map((m,J)=>({char:R(m),color:"black",size:a*.75,x:S+a/2,y:(J+.5)*a})),k={char:R(e.playerState.pendingTrinket),color:e.playerState.weapon!="none"?"black":"transparent",size:a*.75+Math.sin(Date.now()/125)*a/12,x:S+a/2,y:(e.playerState.trinkets.length+.5)*a},y={char:R("bible"),color:e.playerState.trinkets.includes("bible")?"black":"transparent",size:a*.75,...me(e.playerState.pos,e.bible)},v={char:R("bible2"),color:e.playerState.trinkets.includes("bible2")?"black":"transparent",size:a*.75,...he(e.playerState.pos,e.bible)},w={char:K(e.playerState.weapon),size:a,color:e.playerState.trinkets.includes("ghost")?Ae:"transparent",...ye(e.playerState.pos)},H=e.caltrops.map(m=>({...m.pos,char:"â–´",color:W,size:a*.5})),I=e.tombstones.map(m=>({char:R("tombstone"),color:"black",size:a*.75,...m.pos}));return[...c,...l,...H,...i,o,n,f,...s,...x,...I,k,y,v,w]},Ge=(e,o)=>{for(let s=0;s<10;s++){const i=r.fromAngle(Math.random()*Math.PI*2),l=r.sum(r.mult(i,a),e);if(o.every(p=>!r.squareCollision(p,l,a)))return i}},Ue=e=>({pos:e,type:"slime",state:"paused",movementDirection:r.zero,symbol:Symbol(),hurt:!1,hurtSymbol:Symbol(),health:5}),Xe=e=>({pos:e,type:"fast-slime",state:"paused",movementDirection:r.zero,symbol:Symbol(),hurt:!1,hurtSymbol:Symbol(),health:5}),_e=e=>({pos:e,type:"turret",state:"paused",movementDirection:r.zero,symbol:Symbol(),hurt:!1,hurtSymbol:Symbol(),health:8}),$e=e=>({pos:e,type:"imp",state:"paused",movementDirection:r.zero,symbol:Symbol(),hurt:!1,hurtSymbol:Symbol(),health:7}),Ke=e=>({pos:e,type:"rhino",state:"paused",movementDirection:r.zero,symbol:Symbol(),hurt:!1,hurtSymbol:Symbol(),health:4}),Qe=[{type:"slime",difficulty:1,constructor:Ue},{type:"fast-slime",difficulty:2,constructor:Xe},{type:"turret",difficulty:3,constructor:_e},{type:"imp",difficulty:3,constructor:$e},{type:"rhino",difficulty:3,constructor:Ke}],je=(e,o,s,i)=>{const l=Qe.filter(n=>s.includes(n.type));let c=Je([e,...o]),p=i;const g=[];for(;p>0;){const n=G(l);p-=n.difficulty,g.push(n)}return g.map(n=>{const h=G(c);return c=c.filter(u=>u!=h),n.constructor(h)})},Je=e=>{const o=M/a,s=S/a,i=[...Array(s).keys()],l=[...Array(o).keys()];return i.flatMap(p=>l.map(g=>({x:p,y:g}))).map(p=>r.mult(p,a)).filter(p=>e.every(g=>!r.squareCollision(p,g,a)))},Ze=(e,o,s,i)=>{const l=e.hurt&&s.has(e.hurtSymbol)?!1:e.hurt;return e.type=="turret"&&e.state!="paused"&&s.has(e.symbol)?(i.push({id:e.symbol,time:Math.random()*5+1}),{...e,hurt:l,state:e.state=="idle"?"shooting":"idle"}):e.type=="rhino"&&e.state!="paused"&&s.has(e.symbol)?(i.push({id:e.symbol,time:e.state=="idle"?1:Math.random()*5+1}),{...e,hurt:l,state:e.state=="moving"?"idle":"moving",movementDirection:r.normalize(r.sub(o.playerState.pos,e.pos))}):e.type=="imp"&&e.state!="paused"&&s.has(e.symbol)?(i.push({id:e.symbol,time:e.state=="idle"?Math.random()+1:1}),{...e,hurt:l,state:e.state=="moving"?"idle":"moving",movementDirection:Ge(e.pos,o.obstacles.map(c=>c.pos))}):{...e,hurt:l}},et=(e,o,s)=>{if(s.has("generic-rapid")&&e.type=="turret"&&e.state=="shooting"){const i=r.normalize(r.sub(o.playerState.pos,e.pos));return z(e.pos,r.zero,i,D,"normal",!0)}if(e.type=="imp"&&e.state=="idle"&&s.has(e.symbol)){const i=r.normalize(r.sub(o.playerState.pos,e.pos));return z(e.pos,r.zero,i,D,"normal",!0)}},pe=(e,o,s)=>{const i=g=>s.every(n=>!r.squareCollision(n,g,a)),l=r.sum(e,o);if(i(l))return l;const c={x:e.x+o.x,y:e.y};if(i(c))return c;const p={x:e.x,y:e.y+o.y};return i(p)?p:e},tt=e=>{const o=e.reduce((l,c)=>l+c.chance,0),s=Math.random()*o;let i=0;for(const l of e)if(i+=l.chance,s<=i)return l.option;return null};function L(e,o,s){const i=[],l=(u,f,x)=>Math.abs((u.x*(f.y-x.y)+f.x*(x.y-u.y)+x.x*(u.y-f.y))/2),c=u=>{const f=l(e,o,s),x=l(u,o,s),k=l(e,u,s),y=l(e,o,u);return f===x+k+y},p=Math.min(e.x,o.x,s.x),g=Math.max(e.x,o.x,s.x),n=Math.min(e.y,o.y,s.y),h=Math.max(e.y,o.y,s.y);for(let u=Math.ceil(p);u<=Math.floor(g);u++)for(let f=Math.ceil(n);f<=Math.floor(h);f++){const x={x:u,y:f};c(x)&&i.push(x)}return i}const Q=(e,o)=>e.map(s=>({x:o.x-s.x,y:s.y})),fe=(e,o)=>e.map(s=>({x:s.x,y:o.y-s.y})),ot=(e,o)=>fe(Q(e,o),o),C=(e,o,s,i)=>{const l=L(e,o,s).map(p=>r.mult(p,a)),c=L(o,s,i).map(p=>r.mult(p,a));return[...l,...c]},Y=e=>Array.from({length:e},(o,s)=>s),ge=e=>{const o=Y(M/a).map(c=>({x:a/2,y:c*a+a/2})),s=Y(M/a).map(c=>({x:S-a/2,y:c*a+a/2})),i=Y(S/a).map(c=>({y:a/2,x:c*a+a/2})),l=Y(S/a).map(c=>({y:M-a/2,x:c*a+a/2}));return[...o,...s,...i,...l].map(c=>({pos:c,type:e}))},st=()=>{const e=L({x:3,y:3},{x:5,y:5},{x:3,y:5}).map(l=>r.mult(l,a)),o=L({x:23,y:3},{x:21,y:5},{x:23,y:5}).map(l=>r.mult(l,a)),s=L({x:3,y:12},{x:5,y:10},{x:3,y:10}).map(l=>r.mult(l,a)),i=L({x:23,y:12},{x:21,y:10},{x:23,y:10}).map(l=>r.mult(l,a));return[...e,...o,...s,...i]},rt=()=>C({x:10,y:6},{x:10,y:9},{x:17,y:6},{x:17,y:9}),nt=()=>{const e=C({x:5,y:6},{x:5,y:9},{x:12,y:6},{x:12,y:9}),o=C({x:15,y:6},{x:15,y:9},{x:22,y:6},{x:22,y:9});return[...e,...o]},N=()=>{const e=C({x:3,y:3},{x:3,y:6},{x:8,y:3},{x:8,y:6}),o=C({x:12,y:7},{x:12,y:8},{x:17,y:5},{x:17,y:10}),s=C({x:22,y:10},{x:22,y:12},{x:23,y:10},{x:23,y:12});return[...e,...o,...s]},ue=()=>{const e=C({x:10,y:4},{x:10,y:5},{x:17,y:4},{x:17,y:5}),o=C({x:10,y:6},{x:10,y:10},{x:12,y:6},{x:12,y:10}),s=C({x:10,y:10},{x:10,y:11},{x:17,y:10},{x:17,y:11});return[...e,...o,...s]},at=e=>tt([{chance:1,option:st()},{chance:1,option:rt()},{chance:1,option:nt()},{chance:1,option:N()},{chance:1,option:ue()},{chance:1,option:ot(N(),{x:S,y:M})},{chance:1,option:Q(N(),{x:S,y:M})},{chance:1,option:fe(N(),{x:S,y:M})},{chance:1,option:Q(ue(),{x:S,y:M})}]).map(o=>({pos:o,type:"block"})).concat(ge(e)),xe=[{name:"Level 1",walls:"wall1",enemyTypes:["slime","imp"],difficulties:[5,6,7,8,9]},{name:"Level 2",walls:"wall2",enemyTypes:["fast-slime","turret","imp"],difficulties:[10,11,12,13,14]},{name:"Level 3",walls:"wall3",enemyTypes:["fast-slime","turret","imp","rhino"],difficulties:[15,16,17,18,19]}],lt=(e,o,s)=>{const i=xe[o],l=i?at(i.walls):[];return{playerState:{...s,pos:U},canShoot:!0,bullets:[],enemies:i?je(U,l.map(p=>p.pos),i.enemyTypes,i.difficulties[e]):[],obstacles:l,drops:[],roomIndex:e,levelIndex:o,bible:0,caltrops:[],tombstones:[],won:!i}},it=e=>{const o=xe[0],s=ge(o.walls);return{playerState:{...e,pos:U},canShoot:!0,bullets:[],enemies:[],obstacles:s,drops:[...Array(3).keys()].map((l,c)=>de({x:S/2+(c-1)*a*3,y:M/2})),roomIndex:-1,levelIndex:0,bible:0,caltrops:[],tombstones:[],won:!1}},ct=(e,o,s)=>{var re;if(e.playerState.health==0||e.won)return{state:e,timers:[]};const{canShoot:i,obstacles:l,roomIndex:c,levelIndex:p,bible:g}=e,n={...e.playerState};let h=[...e.enemies],u=[...e.bullets],f=[...e.drops],x=[...e.caltrops],k=[...e.tombstones];const y=[],v=n.pos,w={x:(o.has("move-right")?+q:0)+(o.has("move-left")?-q:0),y:(o.has("move-down")?+q:0)+(o.has("move-up")?-q:0)},H=r.mult(w,s),I=[...h.map(t=>t.pos),...l.filter(t=>n.trinkets.includes("passthrough")?t.type!="block":!0).map(t=>t.pos)];n.pos=pe(n.pos,H,I),n.trinkets.includes("bus")&&(r.distance(v,n.pos)>.1?n.health=Math.min(n.health+Be*s,100):n.health-=Oe*s);const m=k.filter(t=>!r.squareCollision(t.pos,n.pos,a));if(n.health=Math.min(n.health+(k.length-m.length)*5,100),k=m.map(t=>({...t,lifetime:t.lifetime+s})).filter(t=>t.lifetime<Fe),x=x.map(t=>({...t,age:t.age+=s})).filter(t=>t.age<8),o.has("swamp")){const d=[n.pos,r.sum(n.pos,r.random(a/2)),r.sum(n.pos,r.random(a/2)),r.sum(n.pos,r.random(a/2)),r.sum(n.pos,r.random(a/2))].map(b=>({age:0,pos:b}));x=x.concat(d),y.push({id:"swamp",time:1})}const be=o.has("shoot-cooldown")||i;let P=[],Z=!1;if(i){let t;if(o.has("shoot-right")?t=r.right:o.has("shoot-left")?t=r.left:o.has("shoot-up")?t=r.up:o.has("shoot-down")&&(t=r.down),t){const d=n.trinkets.includes("twins")?2:1;for(let b=0;b<d;b++)n.weapon=="none"?P.push(z(n.pos,w,t,D,"normal",!1)):n.weapon=="big-gun"?P.push(z(n.pos,w,t,D,"big",!1)):n.weapon=="uzi"?P.push(z(n.pos,w,F(t,.15),D*1.5,"small",!1)):n.weapon=="glock"?P.push(z(n.pos,w,F(t,.05),D*2,"small",!1),z(r.sum(n.pos,r.mult(t,a/2)),w,F(t,.05),D*2,"small",!1),z(r.sum(n.pos,r.mult(t,a)),w,F(t,.05),D*2,"small",!1)):n.weapon=="shotgun"&&P.push(O(n.pos,w,t),O(n.pos,w,t),O(n.pos,w,t),O(n.pos,w,t),O(n.pos,w,t)),t=r.mult(t,-1);y.push({id:"shoot-cooldown",time:Te(n.weapon)}),Z=!0}}if(o.has("rocket")){const t=h.map(d=>({enemy:d,distance:r.distance(d.pos,n.pos)})).sort((d,b)=>d.distance-b.distance)[0];t&&P.push(z(n.pos,r.zero,r.normalize(r.sub(t.enemy.pos,n.pos)),D,"rocket",!1)),y.push({id:"rocket",time:ie})}const we=P.filter(t=>l.every(d=>!r.squareCollision(t.pos,d.pos,a)));u=u.map(t=>({...t,pos:r.sum(t.pos,r.mult(t.speed,s))})),u=u.map(t=>({...t,speed:t.type=="shotgun"?r.mult(t.speed,1-Math.min(s*4,1)):t.type=="rocket"?r.sum(t.speed,r.mult(r.normalize(t.speed),s*500)):t.speed})).filter(t=>!(t.type=="shotgun"&&r.distance(r.zero,t.speed)<a*3)),h=h.map(t=>{if(t.state=="paused"||(t.type=="imp"||t.type=="rhino")&&t.state!="moving")return t;const d=r.sub(n.pos,t.pos),b=(()=>{switch(t.type){case"slime":case"fast-slime":return r.normalize(d);case"rhino":case"imp":return t.movementDirection;default:return r.zero}})(),E=(()=>{switch(t.type){case"slime":return r.mult(b,q/2*s);case"fast-slime":return r.mult(b,q*s);case"imp":return r.mult(b,q*s);case"rhino":return r.mult(b,q*3*s);default:return r.zero}})(),_=[n.pos,...h.filter(A=>A!=t).map(A=>A.pos),...l.map(A=>A.pos)],B=x.find(A=>r.squareCollision(A.pos,t.pos,a))?.5:1,$=pe(t.pos,r.mult(E,B),_);return{...t,pos:$}}),h=h.map(t=>Ze(t,e,o,y));const Se=h.map(t=>et(t,e,o)).filter(t=>t);u=[...u,...we,...Se];const ee=u.filter(t=>!t.enemy).flatMap(t=>h.map(d=>({bullet:t,enemy:d}))).filter(t=>r.distance(t.bullet.pos,t.enemy.pos)<=a/2),te=new Set(ee.map(t=>t.bullet));u=u.filter(t=>!te.has(t)),h=h.map(t=>{const d=ee.filter(B=>B.enemy==t).reduce((B,$)=>B+ce($.bullet.type),0),b=n.trinkets.includes("bible")&&r.squareCollision(me(n.pos,g),t.pos,a*2)?16*s:0,E=n.trinkets.includes("bible2")&&r.squareCollision(he(n.pos,g),t.pos,a*2)?16*s:0,_=n.trinkets.includes("ghost")&&r.squareCollision(ye(n.pos),t.pos,a)?16*s:0,V=d+b+E+_;return V>0&&!t.hurt&&y.push({id:t.hurtSymbol,time:.125}),{...t,hurt:V>0?!0:t.hurt,health:t.health-V}});const ke=[...te].filter(t=>t.type!="rocket").reduce((t,d)=>t+ce(d.type),0);n.weapon!="none"&&(n.weaponHealth-=ke*4,n.weaponHealth<0&&(n.weapon="none",n.trinkets.includes(n.pendingTrinket)||(n.trinkets=[...n.trinkets,n.pendingTrinket],n.pendingTrinket=="swamp"&&y.push({id:"swamp",time:1}),n.pendingTrinket=="rocket"&&y.push({id:"rocket",time:ie}))));const oe=h.filter(t=>t.health<=0).filter(()=>Math.random()>.5),Me=oe.map(t=>de(t.pos));if(f.push(...Me),n.trinkets.includes("tombstone")){const t=h.filter(d=>d.health<=0).filter(d=>!oe.includes(d)).map(d=>({pos:d.pos,lifetime:0}));k.push(...t)}h=h.filter(t=>t.health>0);const De=u.flatMap(t=>l.map(d=>({bu:t,os:d}))).filter(t=>r.squareCollision(t.bu.pos,t.os.pos,a)),ze=n.trinkets.includes("rubber");u=u.map(t=>{const d=De.find(b=>b.bu==t);if(!t.enemy&&t.lifetime>Ee)return null;if(!d)return{...t,lifetime:t.lifetime+s};if(!t.enemy&&ze&&t.type!="rocket"){const b=Math.abs(t.pos.x-d.os.pos.x),E=Math.abs(t.pos.y-d.os.pos.y);return{...t,lifetime:t.lifetime+s,speed:E>b?{x:t.speed.x,y:-t.speed.y}:{x:-t.speed.x,y:t.speed.y}}}return null}).filter(t=>t);const se=u.filter(t=>t.enemy).filter(t=>r.squareCollision(t.pos,n.pos,a)),Ce=new Set(se);u=u.filter(t=>!Ce.has(t));const qe=h.filter(t=>r.squareCollision(t.pos,n.pos,a+1));(se.length>0||qe.length>0)&&!n.hurt&&(n.health-=Ie,y.push({id:"hurt-cooldown",time:Le}),n.hurt=!0);const T=f.find(t=>r.squareCollision(t.pos,n.pos,a));if(T&&(n.weapon=T.type,n.weaponHealth=100,n.pendingTrinket=T.trinket,n.health=Math.min(n.health+He,100),f=f.filter(t=>t!=T)),o.has("generic-rapid")&&y.push({id:"generic-rapid",time:1}),o.has("room-start-cooldown")&&(h=h.map(t=>({...t,state:"idle"})),h.filter(t=>t.type=="imp"||t.type=="turret"||t.type=="rhino").forEach(t=>y.push({id:t.symbol,time:Math.random()*4}))),o.has("hurt-cooldown")&&(n.hurt=!1),h.length==0&&l.push({pos:r.mult({x:13.5,y:14.5},a),type:"door"}),r.squareCollision(n.pos,((re=l.find(t=>t.type=="door"))==null?void 0:re.pos)??r.zero,a*2)){const t=lt((c+1)%le,c+1==le?p+1:p,n);return y.push({id:"room-start-cooldown",time:1}),{timers:y,state:t}}return{timers:y,state:{...e,playerState:n,bullets:u,enemies:h,drops:f,canShoot:be&&!Z,bible:(g+s*2)%(Math.PI*2),caltrops:x,tombstones:k}}},j=document.getElementById("bge-canvas");j.width=S+a;j.height=M;const pt=it({health:100,pos:U,hurt:!1,weapon:"none",weaponHealth:100,trinkets:[],pendingTrinket:"bible"}),ut=[{id:"generic-rapid",time:0},{id:"room-start-cooldown",time:1}];ve(j,pt,ct,Ne,ut);
</script>
  <style rel="stylesheet" crossorigin>*{box-sizing:border-box;overflow:hidden}html,body{width:100%;height:100%;padding:0;margin:0}#bge-canvas{width:auto;height:100%;padding:0;margin:0}
</style>
</head>

<body>
    <canvas id="bge-canvas"></canvas>
</body>

</html>